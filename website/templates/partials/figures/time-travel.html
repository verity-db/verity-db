{# Time Travel Query Explorer Figure
   Analog lab clock for point-in-time queries
   Drag hands to rewind state #}

<section class="interactive-section" id="time-travel" aria-labelledby="time-travel-heading">
  <div class="wrapper">
    <header class="interactive-section__header flow" data-space="s">
      <h2 id="time-travel-heading" class="section-title">Time Travel Query Explorer</h2>
      <p class="section-subtitle">
        Drag the clock hand to travel through time.
        <strong>Every past state is perfectly reconstructable.</strong>
      </p>
    </header>

    <figure
      class="interactive-section__figure"
      data-signals="{
        position: 100,
        maxPosition: 100,
        isDragging: false,
        isAnimating: false
      }"
      data-fn-animate-to="
        (target) => {
          if ($isAnimating || $position === target) return;
          $isAnimating = true;
          const start = $position;
          const duration = 1200;
          const startTime = performance.now();
          const easeInOutCubic = t => t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
          const animate = (now) => {
            const elapsed = now - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const eased = easeInOutCubic(progress);
            $position = Math.round(start + (target - start) * eased);
            if (progress < 1) {
              requestAnimationFrame(animate);
            } else {
              $position = target;
              $isAnimating = false;
            }
          };
          requestAnimationFrame(animate);
        }
      "
    >
      <header class="interactive-section__figure-header">
        <span class="interactive-section__fig-label">Fig. 4</span>
        <span class="interactive-section__fig-caption">Drag the clock hand counter-clockwise to rewind. Watch rows appear and values change.</span>
      </header>

      <div class="interactive-section__figure-content">
        <div class="time-travel">
          {# Clock Panel #}
          <div class="time-travel__clock-panel">
            <div
              class="lab-clock"
              data-variant="time-travel"
              data-attr:data-dragging="$isDragging"
              data-attr:data-animating="$isAnimating"
            >
              <span class="lab-clock__now-marker">Now</span>

              <div class="lab-clock__face">
                {# Tick marks SVG #}
                <svg class="lab-clock__ticks" viewBox="0 0 100 100">
                  {# 60 tick marks - major every 10 #}
                  <line x1="50.0" y1="10.0" x2="50.0" y2="3.0" class="lab-clock__tick--major" />
                  <line x1="54.5" y1="7.2" x2="54.9" y2="3.3" class="lab-clock__tick--minor" />
                  <line x1="58.9" y1="7.9" x2="59.8" y2="4.0" class="lab-clock__tick--minor" />
                  <line x1="63.3" y1="9.1" x2="64.5" y2="5.3" class="lab-clock__tick--minor" />
                  <line x1="67.5" y1="10.7" x2="69.1" y2="7.1" class="lab-clock__tick--minor" />
                  <line x1="71.5" y1="12.8" x2="73.5" y2="9.3" class="lab-clock__tick--minor" />
                  <line x1="75.3" y1="15.2" x2="77.6" y2="12.0" class="lab-clock__tick--minor" />
                  <line x1="78.8" y1="18.0" x2="81.4" y2="15.1" class="lab-clock__tick--minor" />
                  <line x1="82.0" y1="21.2" x2="84.9" y2="18.6" class="lab-clock__tick--minor" />
                  <line x1="84.8" y1="24.7" x2="88.0" y2="22.4" class="lab-clock__tick--minor" />
                  <line x1="84.6" y1="30.0" x2="90.7" y2="26.5" class="lab-clock__tick--major" />
                  <line x1="89.3" y1="32.5" x2="92.9" y2="30.9" class="lab-clock__tick--minor" />
                  <line x1="90.9" y1="36.7" x2="94.7" y2="35.5" class="lab-clock__tick--minor" />
                  <line x1="92.1" y1="41.1" x2="96.0" y2="40.2" class="lab-clock__tick--minor" />
                  <line x1="92.8" y1="45.5" x2="96.7" y2="45.1" class="lab-clock__tick--minor" />
                  <line x1="93.0" y1="50.0" x2="97.0" y2="50.0" class="lab-clock__tick--minor" />
                  <line x1="92.8" y1="54.5" x2="96.7" y2="54.9" class="lab-clock__tick--minor" />
                  <line x1="92.1" y1="58.9" x2="96.0" y2="59.8" class="lab-clock__tick--minor" />
                  <line x1="90.9" y1="63.3" x2="94.7" y2="64.5" class="lab-clock__tick--minor" />
                  <line x1="89.3" y1="67.5" x2="92.9" y2="69.1" class="lab-clock__tick--minor" />
                  <line x1="84.6" y1="70.0" x2="90.7" y2="73.5" class="lab-clock__tick--major" />
                  <line x1="84.8" y1="75.3" x2="88.0" y2="77.6" class="lab-clock__tick--minor" />
                  <line x1="82.0" y1="78.8" x2="84.9" y2="81.4" class="lab-clock__tick--minor" />
                  <line x1="78.8" y1="82.0" x2="81.4" y2="84.9" class="lab-clock__tick--minor" />
                  <line x1="75.3" y1="84.8" x2="77.6" y2="88.0" class="lab-clock__tick--minor" />
                  <line x1="71.5" y1="87.2" x2="73.5" y2="90.7" class="lab-clock__tick--minor" />
                  <line x1="67.5" y1="89.3" x2="69.1" y2="92.9" class="lab-clock__tick--minor" />
                  <line x1="63.3" y1="90.9" x2="64.5" y2="94.7" class="lab-clock__tick--minor" />
                  <line x1="58.9" y1="92.1" x2="59.8" y2="96.0" class="lab-clock__tick--minor" />
                  <line x1="54.5" y1="92.8" x2="54.9" y2="96.7" class="lab-clock__tick--minor" />
                  <line x1="50.0" y1="90.0" x2="50.0" y2="97.0" class="lab-clock__tick--major" />
                  <line x1="45.5" y1="92.8" x2="45.1" y2="96.7" class="lab-clock__tick--minor" />
                  <line x1="41.1" y1="92.1" x2="40.2" y2="96.0" class="lab-clock__tick--minor" />
                  <line x1="36.7" y1="90.9" x2="35.5" y2="94.7" class="lab-clock__tick--minor" />
                  <line x1="32.5" y1="89.3" x2="30.9" y2="92.9" class="lab-clock__tick--minor" />
                  <line x1="28.5" y1="87.2" x2="26.5" y2="90.7" class="lab-clock__tick--minor" />
                  <line x1="24.7" y1="84.8" x2="22.4" y2="88.0" class="lab-clock__tick--minor" />
                  <line x1="21.2" y1="82.0" x2="18.6" y2="84.9" class="lab-clock__tick--minor" />
                  <line x1="18.0" y1="78.8" x2="15.1" y2="81.4" class="lab-clock__tick--minor" />
                  <line x1="15.2" y1="75.3" x2="12.0" y2="77.6" class="lab-clock__tick--minor" />
                  <line x1="15.4" y1="70.0" x2="9.3" y2="73.5" class="lab-clock__tick--major" />
                  <line x1="10.7" y1="67.5" x2="7.1" y2="69.1" class="lab-clock__tick--minor" />
                  <line x1="9.1" y1="63.3" x2="5.3" y2="64.5" class="lab-clock__tick--minor" />
                  <line x1="7.9" y1="58.9" x2="4.0" y2="59.8" class="lab-clock__tick--minor" />
                  <line x1="7.2" y1="54.5" x2="3.3" y2="54.9" class="lab-clock__tick--minor" />
                  <line x1="7.0" y1="50.0" x2="3.0" y2="50.0" class="lab-clock__tick--minor" />
                  <line x1="7.2" y1="45.5" x2="3.3" y2="45.1" class="lab-clock__tick--minor" />
                  <line x1="7.9" y1="41.1" x2="4.0" y2="40.2" class="lab-clock__tick--minor" />
                  <line x1="9.1" y1="36.7" x2="5.3" y2="35.5" class="lab-clock__tick--minor" />
                  <line x1="10.7" y1="32.5" x2="7.1" y2="30.9" class="lab-clock__tick--minor" />
                  <line x1="15.4" y1="30.0" x2="9.3" y2="26.5" class="lab-clock__tick--major" />
                  <line x1="15.2" y1="24.7" x2="12.0" y2="22.4" class="lab-clock__tick--minor" />
                  <line x1="18.0" y1="21.2" x2="15.1" y2="18.6" class="lab-clock__tick--minor" />
                  <line x1="21.2" y1="18.0" x2="18.6" y2="15.1" class="lab-clock__tick--minor" />
                  <line x1="24.7" y1="15.2" x2="22.4" y2="12.0" class="lab-clock__tick--minor" />
                  <line x1="28.5" y1="12.8" x2="26.5" y2="9.3" class="lab-clock__tick--minor" />
                  <line x1="32.5" y1="10.7" x2="30.9" y2="7.1" class="lab-clock__tick--minor" />
                  <line x1="36.7" y1="9.1" x2="35.5" y2="5.3" class="lab-clock__tick--minor" />
                  <line x1="41.1" y1="7.9" x2="40.2" y2="4.0" class="lab-clock__tick--minor" />
                  <line x1="45.5" y1="7.2" x2="45.1" y2="3.3" class="lab-clock__tick--minor" />
                </svg>

                {# Crosshairs SVG #}
                <svg class="lab-clock__crosshairs" viewBox="0 0 100 100">
                  <line x1="50" y1="15" x2="50" y2="85" />
                  <line x1="15" y1="50" x2="85" y2="50" />
                </svg>

                {# Position numbers #}
                <div class="lab-clock__numbers">
                  <span class="lab-clock__number" data-value="0">0</span>
                  <span class="lab-clock__number" data-value="25" style="top: 50%; right: 12%; transform: translateY(-50%);">25</span>
                  <span class="lab-clock__number" data-value="50" style="bottom: 12%; left: 50%; transform: translateX(-50%);">50</span>
                  <span class="lab-clock__number" data-value="75" style="top: 50%; left: 12%; transform: translateY(-50%);">75</span>
                  <span class="lab-clock__number" data-value="100" style="top: 8%; left: 50%; transform: translateX(-50%);">100</span>
                </div>

                {# Clock hand #}
                <div
                  class="lab-clock__hand lab-clock__hand--main"
                  data-attr:style="'transform: rotate(' + ($position / $maxPosition * 360) + 'deg)'"
                ></div>

                {# Center dot #}
                <div class="lab-clock__center"></div>
              </div>

              {# Invisible interaction area for dragging #}
              <div
                class="lab-clock__interaction"
                data-on:pointerdown="
                  if ($isAnimating) return;
                  $isDragging = true;
                  evt.target.setPointerCapture(evt.pointerId);
                "
                data-on:pointermove="
                  if (!$isDragging || $isAnimating) return;
                  const rect = evt.currentTarget.parentElement.getBoundingClientRect();
                  const cx = rect.left + rect.width / 2;
                  const cy = rect.top + rect.height / 2;
                  const dx = evt.clientX - cx;
                  const dy = evt.clientY - cy;
                  let angle = Math.atan2(dy, dx) * (180 / Math.PI) + 90;
                  if (angle < 0) angle += 360;
                  $position = Math.round((angle / 360) * $maxPosition);
                "
                data-on:pointerup="
                  $isDragging = false;
                  evt.target.releasePointerCapture(evt.pointerId);
                "
                data-on:pointercancel="
                  $isDragging = false;
                "
                aria-label="Drag to change position"
                role="slider"
                aria-valuemin="0"
                aria-valuemax="100"
                data-attr:aria-valuenow="$position"
              ></div>
            </div>

            {# Position readout #}
            <div class="lab-clock__readout">
              <span class="lab-clock__readout-label">Log Position</span>
              <output class="lab-clock__readout-value" data-text="$position">100</output>
            </div>

            {# Quick navigation buttons #}
            <div class="time-travel__quick-nav cluster">
              <button
                class="interactive-button"
                data-on:click="@animateTo(0)"
                data-attr:data-variant="$position === 0 ? 'primary' : null"
                data-attr:disabled="$isAnimating ? true : null"
              >Start</button>
              <button
                class="interactive-button"
                data-on:click="@animateTo(50)"
                data-attr:data-variant="$position === 50 ? 'primary' : null"
                data-attr:disabled="$isAnimating ? true : null"
              >Midpoint</button>
              <button
                class="interactive-button"
                data-on:click="@animateTo(100)"
                data-attr:data-variant="$position === 100 ? 'primary' : null"
                data-attr:disabled="$isAnimating ? true : null"
              >Now</button>
            </div>
          </div>

          {# Results Panel #}
          <div class="time-travel__results-panel">
            <header class="time-travel__results-header">
              <h3 class="time-travel__results-title">Query Results</h3>
              <span class="time-travel__results-badge" data-text="'AS OF Position #' + $position">AS OF Position #100</span>
            </header>

            <div class="time-travel__query">
              <code>SELECT * FROM accounts AS OF POSITION <span data-text="$position">100</span>;</code>
            </div>

            <div class="time-travel__table-wrapper">
              <table class="time-travel__table">
                <thead>
                  <tr>
                    <th>id</th>
                    <th>name</th>
                    <th>balance</th>
                    <th>status</th>
                  </tr>
                </thead>
                <tbody>
                  {# Row 1: Acme Corp - appears at 10, name typo fixed at 35 #}
                  <tr
                    data-show="$position >= 10"
                    data-attr:class="$position >= 10 && $position < 18 ? 'time-travel__row--new' : ''"
                  >
                    <td>1</td>
                    <td data-text="$position >= 35 ? 'Acme Corp' : 'Acme Crop'">Acme Corp</td>
                    <td data-text="$position >= 75 ? '12,400' : ($position >= 45 ? '8,200' : '5,000')">12,400</td>
                    <td>active</td>
                  </tr>

                  {# Row 2: Globex Inc - appears at 30, status workflow: pending → verified → active #}
                  <tr
                    data-show="$position >= 30"
                    data-attr:class="$position >= 30 && $position < 38 ? 'time-travel__row--new' : ''"
                  >
                    <td>2</td>
                    <td>Globex Inc</td>
                    <td data-text="$position >= 80 ? '24,800' : '18,500'">24,800</td>
                    <td data-text="$position >= 70 ? 'active' : ($position >= 50 ? 'verified' : 'pending')">active</td>
                  </tr>

                  {# Row 3: Initech LLC - appears at 55 #}
                  <tr
                    data-show="$position >= 55"
                    data-attr:class="$position >= 55 && $position < 63 ? 'time-travel__row--new' : ''"
                  >
                    <td>3</td>
                    <td>Initech LLC</td>
                    <td data-text="$position >= 85 ? '3,200' : '7,100'">3,200</td>
                    <td>active</td>
                  </tr>

                  {# Row 4: Stark Industries - appears at 65, balance grows steadily #}
                  <tr
                    data-show="$position >= 65"
                    data-attr:class="$position >= 65 && $position < 73 ? 'time-travel__row--new' : ''"
                  >
                    <td>4</td>
                    <td data-text="$position >= 90 ? 'Stark Industries' : 'Stark Ind'">Stark Industries</td>
                    <td data-text="$position >= 95 ? '156,000' : '42,000'">156,000</td>
                    <td>active</td>
                  </tr>

                  {# Row 5: Wayne Enterprises - appears at 75 #}
                  <tr
                    data-show="$position >= 75"
                    data-attr:class="$position >= 75 && $position < 83 ? 'time-travel__row--new' : ''"
                  >
                    <td>5</td>
                    <td>Wayne Enterprises</td>
                    <td data-text="$position >= 90 ? '320,000' : '280,000'">320,000</td>
                    <td>active</td>
                  </tr>

                  {# Row 6: Umbrella Corp - appears at 85 #}
                  <tr
                    data-show="$position >= 85"
                    data-attr:class="$position >= 85 && $position < 93 ? 'time-travel__row--new' : ''"
                  >
                    <td>6</td>
                    <td>Umbrella Corp</td>
                    <td>8,900</td>
                    <td data-text="$position >= 95 ? 'active' : 'pending'">active</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="time-travel__hint" data-show="$position < 10">
              <em>No records exist yet. Move forward to see the first account created at position #10.</em>
            </div>

            <div class="time-travel__hint" data-show="$position >= 10 && $position < 35">
              <em>Notice the typo: "Acme Crop" gets corrected to "Acme Corp" at position #35.</em>
            </div>

            <div class="time-travel__hint" data-show="$position >= 50 && $position < 55">
              <em>Globex just got verified. Three more accounts will be created after this point.</em>
            </div>

            <div class="time-travel__hint" data-show="$position >= 85 && $position < 95">
              <em>Umbrella Corp just joined - still pending approval.</em>
            </div>

            <div class="time-travel__row-count">
              <span data-text="(($position >= 10 ? 1 : 0) + ($position >= 30 ? 1 : 0) + ($position >= 55 ? 1 : 0) + ($position >= 65 ? 1 : 0) + ($position >= 75 ? 1 : 0) + ($position >= 85 ? 1 : 0)) + ' rows'">6 rows</span>
            </div>
          </div>
        </div>
      </div>

      <div class="interactive-section__figure-footer cluster">
        <div class="interactive-section__legend">
          <span class="legend-item">
            <span class="legend-swatch" data-state="valid"></span>
            Active Row
          </span>
          <span class="legend-item">
            <span class="legend-swatch" data-state="invalid"></span>
            Deleted (recoverable)
          </span>
        </div>
      </div>
    </figure>
  </div>
</section>
